<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旅行プラン・プロンプトジェネレーター (marked.js版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     crossorigin=""/>
</head>
<body class="bg-gray-100 text-gray-800 font-sans p-5">
    <!-- ★★★ テスト実行ボタンをここに追加 ★★★ -->
    <div class="flex justify-center my-4 border-t pt-4">
        <button type="button" id="run-tests-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors" style="display:none;">シナリオテストを実行</button>
    </div>
    
    <div class="max-w-3xl mx-auto bg-white p-8 rounded-lg shadow-lg">
        <div class="text-center mb-8 relative">
            <h1 class="text-3xl font-bold text-blue-600 mb-1">旅行プラン・プロンプトジェネレーター</h1>
            <p class="text-sm text-gray-500 italic" id="version-info"></p>
            <button type="button" id="open-settings-modal-btn" class="absolute top-0 right-0 p-2 text-2xl hover:bg-gray-200 rounded-full" aria-label="設定">⚙️</button>
            <p id="save-status" class="text-green-600 font-semibold mt-2 h-6"></p> <!-- メッセージ表示領域 -->
        </div>

        <button type="button" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mb-6 transition-colors toggle-import-btn">以前のプロンプトを読み込む</button>
        <fieldset id="import-area" class="border border-gray-300 rounded-md p-6 mb-6" style="display:none;">
            <legend class="text-lg font-bold text-blue-600 px-2">プロンプトから入力フォームに反映</legend>
            <label for="import-prompt" class="block mb-2 font-semibold">ここに以前生成したプロンプトを貼り付けてください</label>
            <textarea id="import-prompt" class="w-full p-2 border border-gray-300 rounded-md min-h-[150px] bg-gray-50 mb-4 focus:ring focus:ring-blue-500 focus:border-blue-500" placeholder="「# 旅行プランの作成依頼」から始まるテキストを貼り付けます..."></textarea>
            <button type="button" class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors import-button">フォームに反映する</button>
            <p id="import-status" class="text-sm text-gray-500 mt-3 text-center"></p>
        </fieldset>

        <fieldset class="border border-gray-300 rounded-md p-6 mb-6">
            <legend class="text-lg font-bold text-blue-600 px-2">プランニング・モード</legend>
            <label class="flex items-center font-normal cursor-pointer">
                <input type="checkbox" id="ai-suggestion-mode" class="mr-3 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                AIに行先から提案してもらう
            </label>
            <div id="ai-suggestion-inputs" class="mt-4 border-t pt-4" style="display:none;">
                <label for="arrival-point" class="block mb-2 font-semibold">到着空港・駅</label>
                <input type="text" id="arrival-point" class="w-full p-2 border border-gray-300 rounded-md mb-4 focus:ring focus:ring-blue-500 focus:border-blue-500" placeholder="例：羽田空港, 新千歳空港, 東京駅">
                <label class="block mb-2 font-semibold">旅行期間</label>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="trip-start-date" class="text-sm font-normal">開始日</label>
                        <input type="date" id="trip-start-date" class="w-full p-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="trip-end-date" class="text-sm font-normal">終了日</label>
                        <input type="date" id="trip-end-date" class="w-full p-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <label for="trip-remarks" class="block mb-2 font-semibold">備考・その他の要望</label>
                <textarea id="trip-remarks" class="w-full p-2 border border-gray-300 rounded-md min-h-[100px] focus:ring focus:ring-blue-500 focus:border-blue-500" placeholder="例：往路：新千歳 9:00発 - 羽田 10:35着
復路：羽田 18:00発 - 新千歳 19:35着
あまり歩き回りたくないです。"></textarea>
            </div>
        </fieldset>

        <details class="border border-gray-300 rounded-md mb-6 group" open>
                <summary class="list-none p-4 font-semibold cursor-pointer text-lg text-blue-600 flex justify-between items-center">
                    旅行全体の基本情報
                    <span class="summary-arrow text-gray-400 text-xl transition-transform duration-200 group-open:rotate-180">▼</span>
                </summary>
                <div class="p-6 pt-2 border-t">
                    <label for="departure-point" class="block mb-2 font-semibold">出発地</label>
                    <input type="text" id="departure-point" class="w-full p-2 border border-gray-300 rounded-md mb-4 focus:ring focus:ring-blue-500 focus:border-blue-500" placeholder="例：札幌、自宅">
                    <label for="members" class="block mb-2 font-semibold">メンバー構成・体力レベル</label>
                    <input type="text" id="members" class="w-full p-2 border border-gray-300 rounded-md mb-4 focus:ring focus:ring-blue-500 focus:border-blue-500" placeholder="例：30代夫婦、体力に自信あり">
                    <label for="theme" class="block mb-2 font-semibold">旅のテーマ・雰囲気</label>
                    <input type="text" id="theme" class="w-full p-2 border border-gray-300 rounded-md mb-4 focus:ring focus:ring-blue-500 focus:border-blue-500" placeholder="例：レトロな街並みを楽しむ">
                    <label for="priority" class="block mb-2 font-semibold">最優先事項</label>
                    <input type="text" id="priority" class="w-full p-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-500 focus:border-blue-500" placeholder="例：『〇〇展をじっくり見ること』が最優先">
                    <div class="mt-6">
                        <details id="general-transport-details" class="bg-gray-50 p-4 rounded-lg shadow-inner">
                            <summary class="font-semibold cursor-pointer text-blue-600 hover:text-blue-800">
                                往路・復路の交通情報を入力する（任意）
                            </summary>
                            <div class="mt-4 border-t pt-4 space-y-6">
                                <div>
                                    <h4 class="font-bold text-gray-700 mb-2">往路（行き）の情報</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-3 p-3 border rounded-md bg-white">
                                        <div>
                                            <label for="outbound-transport-type" class="block text-sm font-medium text-gray-600">種別</label>
                                            <select id="outbound-transport-type" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:ring focus:ring-blue-500 focus:border-blue-500">
                                                <option value="">未選択</option>
                                                <option>飛行機</option><option>列車</option><option>バス</option><option>フェリー</option><option>その他</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="outbound-transport-name" class="block text-sm font-medium text-gray-600">便名/列車名など</label>
                                            <input type="text" id="outbound-transport-name" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:ring focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="outbound-dep-location" class="block text-sm font-medium text-gray-600">出発地</label>
                                            <input type="text" id="outbound-dep-location" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:ring focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-600">出発時刻</label>
                                            <div class="flex gap-2">
                                                <select id="outbound-dep-hour" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:ring focus:ring-blue-500 focus:border-blue-500"></select>
                                                <select id="outbound-dep-minute" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:ring focus:ring-blue-500 focus:border-blue-500"></select>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="outbound-arr-location" class="block text-sm font-medium text-gray-600">到着地</label>
                                            <input type="text" id="outbound-arr-location" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:ring focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-600">到着時刻</label>
                                            <div class="flex gap-2">
                                                <select id="outbound-arr-hour" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:ring focus:ring-blue-500 focus:border-blue-500"></select>
                                                <select id="outbound-arr-minute" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:ring focus:ring-blue-500 focus:border-blue-500"></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-700 mb-2">復路（帰り）の情報</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-3 p-3 border rounded-md bg-white">
                                        <div>
                                            <label for="inbound-transport-type" class="block text-sm font-medium text-gray-600">種別</label>
                                            <select id="inbound-transport-type" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:ring focus:ring-blue-500 focus:border-blue-500">
                                                <option value="">未選択</option>
                                                <option>飛行機</option><option>列車</option><option>バス</option><option>フェリー</option><option>その他</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="inbound-transport-name" class="block text-sm font-medium text-gray-600">便名/列車名など</label>
                                            <input type="text" id="inbound-transport-name" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:ring focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="inbound-dep-location" class="block text-sm font-medium text-gray-600">出発地</label>
                                            <input type="text" id="inbound-dep-location" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:ring focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-600">出発時刻</label>
                                            <div class="flex gap-2">
                                                <select id="inbound-dep-hour" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:ring focus:ring-blue-500 focus:border-blue-500"></select>
                                                <select id="inbound-dep-minute" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:ring focus:ring-blue-500 focus:border-blue-500"></select>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="inbound-arr-location" class="block text-sm font-medium text-gray-600">到着地</label>
                                            <input type="text" id="inbound-arr-location" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:ring focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-600">到着時刻</label>
                                            <div class="flex gap-2">
                                                <select id="inbound-arr-hour" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:ring focus:ring-blue-500 focus:border-blue-500"></select>
                                                <select id="inbound-arr-minute" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:ring focus:ring-blue-500 focus:border-blue-500"></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
            </details>

            <div id="days-container"></div>

            <div class="text-center my-8">
                <button type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors add-day-btn">旅行日数を追加する</button>
            </div>
            
            <fieldset id="ai-instruction-fieldset" class="border border-gray-300 rounded-md p-6 mb-6">
                <legend class="text-lg font-bold text-blue-600 px-2">AIへの特別指示</legend>
                 <label class="flex items-center font-normal cursor-pointer">
                    <input type="checkbox" id="proactive-suggestions" class="mr-3 h-4 w-4" checked>
                    AIからの魅力的な追加提案（+α）を希望する
                </label>
            </fieldset>
            
            <div class="text-center my-8">
                <button type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors generate-btn">Markdownを生成する</button>
            </div>
        </form>
        
        <div id="output-area" style="display:none;">
            <h2 class="text-2xl font-bold text-blue-600 text-center mt-0 pb-2 border-b-2 border-blue-600">生成されたプロンプト</h2>
            <textarea id="output-markdown" class="w-full p-2 border border-gray-300 rounded-md min-h-[300px] bg-gray-50 mt-6 focus:ring focus:ring-blue-500 focus:border-blue-500" readonly></textarea>
            <p id="markdown-status" class="text-sm text-gray-500 mt-2 text-center"></p>
            <button type="button" class="w-full mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors copy-button">クリップボードにコピー</button>
            
            <div class="mt-6 space-y-2">
                <button type="button" id="execute-gemini-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors" disabled>Geminiで実行</button>
                <button type="button" id="execute-mistral-btn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition-colors" disabled>Mistralで実行</button>
            </div>
            <div id="gemini-response-area" class="mt-6 p-4 border border-gray-200 rounded-md bg-gray-50" style="display:none;">
                <h3 class="font-bold text-lg text-indigo-700 mb-2">Geminiからの応答</h3>
                <div id="gemini-response-content" class="prose max-w-none whitespace-pre-wrap"></div>
            </div>
        </div>
    </div>

    <!-- Modals and Templates -->
    <div class="modal micromodal-slide" id="modal-city" aria-hidden="true">
        <div class="modal__overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" tabindex="-1" data-micromodal-close>
            <div class="modal__container bg-white p-5 w-11/12 max-w-2xl max-h-[90vh] rounded-lg shadow-xl overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="modal-city-title">
                <header class="modal__header flex justify-between items-center border-b border-gray-300 pb-4">
                    <h2 class="modal__title m-0 text-xl font-bold" id="modal-city-title">市町村を選択</h2>
                    <button class="modal__close bg-transparent border-0 cursor-pointer w-8 h-8 relative" aria-label="閉じる" data-micromodal-close></button>
                </header>
                <main class="modal__content mt-6" id="modal-city-content"></main>
            </div>
        </div>
    </div>

    <div class="modal micromodal-slide" id="modal-prefecture" aria-hidden="true">
        <div class="modal__overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" tabindex="-1" data-micromodal-close>
            <div class="modal__container bg-white p-5 w-11/12 max-w-2xl max-h-[90vh] rounded-lg shadow-xl overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="modal-prefecture-title">
                <header class="modal__header flex justify-between items-center border-b border-gray-300 pb-4">
                    <h2 class="modal__title m-0 text-xl font-bold" id="modal-prefecture-title">都道府県を選択</h2>
                    <button class="modal__close bg-transparent border-0 cursor-pointer w-8 h-8 relative" aria-label="閉じる" data-micromodal-close></button>
                </header>
                <main class="modal__content mt-6" id="modal-prefecture-content"></main>
            </div>
        </div>
    </div>

    <div class="modal micromodal-slide" id="modal-theme" aria-hidden="true">
        <div class="modal__overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" tabindex="-1" data-micromodal-close>
            <div class="modal__container bg-white p-5 w-11/12 max-w-2xl max-h-[90vh] rounded-lg shadow-xl overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="modal-theme-title">
                <header class="modal__header flex justify-between items-center border-b border-gray-300 pb-4">
                    <h2 class="modal__title m-0 text-xl font-bold" id="modal-theme-title">目的を選択</h2>
                    <button class="modal__close bg-transparent border-0 cursor-pointer w-8 h-8 relative" aria-label="閉じる" data-micromodal-close></button>
                </header>
                <main class="modal__content mt-6" id="modal-theme-content"></main>
                <footer class="modal__footer mt-6 pt-4 border-t border-gray-300 text-right">
                    <button class="modal__btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors" data-micromodal-close aria-label="完了">完了</button>
                </footer>
            </div>
        </div>
    </div>

    <!-- ★★★ 設定モーダルを追加 ★★★ -->
    <div class="modal micromodal-slide" id="modal-settings" aria-hidden="true">
        <div class="modal__overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" tabindex="-1" data-micromodal-close>
            <div class="modal__container bg-white p-5 w-11/12 max-w-3xl max-h-[90vh] rounded-lg shadow-xl flex flex-col" role="dialog" aria-modal="true" aria-labelledby="modal-settings-title">
                <header class="modal__header flex justify-between items-center border-b border-gray-300 pb-4">
                    <h2 class="modal__title m-0 text-xl font-bold" id="modal-settings-title">設定</h2>
                    <button class="modal__close bg-transparent border-0 cursor-pointer w-8 h-8 relative" aria-label="閉じる" data-micromodal-close></button>
                </header>
                <main class="modal__content mt-4 flex-grow overflow-y-auto" id="modal-settings-content">
                    <!-- ここに設定フォームの中身が入ります -->
                </main>
                <footer class="modal__footer mt-6 pt-4 border-t border-gray-300 text-right space-x-2">
                    <button class="modal__btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors" id="save-settings-btn">保存して閉じる</button>
                    <button class="modal__btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors" data-micromodal-close aria-label="閉じる">キャンセル</button>
                </footer>
            </div>
        </div>
    </div>


    <script src="https://unpkg.com/micromodal/dist/micromodal.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     crossorigin=""></script>

    <script src="js/config.js"></script>
    <script src="js/data_manager.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/markdown_generator.js"></script>
    <script src="js/markdown_parser.js"></script>
    <script src="js/api_client.js"></script>

    <script src="js/main.js"></script>
</body>
</html>
